version: "3.9"
services:
  app:
    container_name: app_test
    build:
      context: ..
      dockerfile: ./tests/Dockerfile.test
    environment:
      - DB_HOST=db_test
      - DB_PORT=3306
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_NAME=mars_test
    depends_on:
      db:
        condition: service_healthy

  db:
    container_name: db_test
    image: mysql:8-debian
    command: --default-authentication-plugin=mysql_native_password
    environment:
       MYSQL_ROOT_PASSWORD: root
       MYSQL_DATABASE: mars_test
    volumes:
      - ./data:/docker-entrypoint-initdb.d/:ro
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 30s
      timeout: 10s
      retries: 5
